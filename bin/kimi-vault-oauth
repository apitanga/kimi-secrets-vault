#!/usr/bin/env python3
"""
kimi-vault OAuth Helper

Generates authorization URL and exchanges auth code for refresh token.
Supports configuration via environment variables or config file.

Usage:
    kimi-vault-oauth
    
Environment Variables:
    KIMI_VAULT_CLIENT_ID     - OAuth client ID
    KIMI_VAULT_CLIENT_SECRET - OAuth client secret
    KIMI_VAULT_REDIRECT_URI  - OAuth redirect URI (default: http://localhost:8080/oauth/callback)
"""

import json
import os
import sys
import urllib.parse
import urllib.request
from pathlib import Path

# Add src to path for imports
SCRIPT_DIR = Path(__file__).parent.resolve()
PROJECT_DIR = SCRIPT_DIR.parent
sys.path.insert(0, str(PROJECT_DIR / "src"))

from kimi_vault.config import VaultConfig

# OAuth configuration
DEFAULT_REDIRECT_URI = "http://localhost:8080/oauth/callback"
SCOPES = [
    "https://www.googleapis.com/auth/gmail.readonly",
    "https://www.googleapis.com/auth/gmail.compose"
]

AUTH_URL = "https://accounts.google.com/o/oauth2/v2/auth"
TOKEN_URL = "https://oauth2.googleapis.com/token"


def get_config() -> tuple[str, str, str]:
    """Get OAuth configuration from env vars or config file"""
    config = VaultConfig()
    
    # Priority: env vars > config file > prompt
    client_id = os.environ.get("KIMI_VAULT_CLIENT_ID") or config.client_id
    client_secret = os.environ.get("KIMI_VAULT_CLIENT_SECRET") or config.client_secret
    redirect_uri = os.environ.get("KIMI_VAULT_REDIRECT_URI", DEFAULT_REDIRECT_URI)
    
    if not client_id:
        print("OAuth Client ID not configured.")
        print("\nYou can set it via:")
        print("  1. Environment variable: export KIMI_VAULT_CLIENT_ID=your_id")
        print("  2. Config file: ~/.config/kimi-vault/config")
        print()
        client_id = input("Enter your OAuth Client ID: ").strip()
    
    return client_id, client_secret, redirect_uri


def generate_auth_url(client_id: str, redirect_uri: str) -> str:
    """Generate the OAuth authorization URL for user to click"""
    params = {
        "client_id": client_id,
        "redirect_uri": redirect_uri,
        "scope": " ".join(SCOPES),
        "response_type": "code",
        "access_type": "offline",  # Request refresh token
        "prompt": "consent"  # Force consent screen to get refresh token
    }
    
    return f"{AUTH_URL}?{urllib.parse.urlencode(params)}"


def exchange_code_for_tokens(
    code: str,
    client_id: str,
    client_secret: str,
    redirect_uri: str
) -> dict:
    """Exchange authorization code for tokens"""
    data = {
        "client_id": client_id,
        "client_secret": client_secret,
        "code": code,
        "grant_type": "authorization_code",
        "redirect_uri": redirect_uri
    }
    
    req = urllib.request.Request(
        TOKEN_URL,
        data=urllib.parse.urlencode(data).encode(),
        headers={"Content-Type": "application/x-www-form-urlencoded"},
        method="POST"
    )
    
    try:
        with urllib.request.urlopen(req) as response:
            return json.loads(response.read().decode())
    except urllib.error.HTTPError as e:
        error_body = e.read().decode()
        try:
            error_json = json.loads(error_body)
            raise RuntimeError(f"Token exchange failed: {error_json.get('error_description', error_body)}")
        except json.JSONDecodeError:
            raise RuntimeError(f"Token exchange failed: {error_body}")


def main():
    print("=" * 60)
    print("üîê Kimi Secrets Vault - OAuth Helper")
    print("=" * 60)
    print()
    
    # Get configuration
    client_id, client_secret, redirect_uri = get_config()
    
    # Generate auth URL
    auth_url = generate_auth_url(client_id, redirect_uri)
    
    print("üìã Step 1: Click this URL to authorize:")
    print()
    print(auth_url)
    print()
    print("=" * 60)
    print()
    print("üìã Step 2: After you authorize, you'll see an error page.")
    print("   That's OK! Copy the URL from your browser address bar.")
    print()
    print("üìã Step 3: Paste the full callback URL here:")
    
    try:
        callback_url = input("> ").strip()
    except KeyboardInterrupt:
        print("\n\nAborted.")
        sys.exit(1)
    
    # Extract auth code from URL
    if "code=" not in callback_url:
        print("‚ùå Could not find authorization code in URL")
        print("Make sure you paste the full callback URL")
        sys.exit(1)
    
    code = callback_url.split("code=")[1].split("&")[0]
    code = urllib.parse.unquote(code)
    
    print()
    print("‚úÖ Authorization code extracted!")
    
    # Get client secret if not already available
    if not client_secret:
        print()
        print("üìã Step 4: Enter your client_secret:")
        client_secret = input("> ").strip()
    
    # Exchange code for tokens
    print()
    print("üîÑ Exchanging auth code for tokens...")
    
    try:
        tokens = exchange_code_for_tokens(code, client_id, client_secret, redirect_uri)
        
        print()
        print("=" * 60)
        print("üéâ SUCCESS! Tokens received:")
        print("=" * 60)
        print()
        print("Refresh Token (SAVE THIS!):")
        refresh_token = tokens.get("refresh_token", "NOT FOUND")
        print(refresh_token)
        print()
        
        if refresh_token == "NOT FOUND":
            print("‚ö†Ô∏è  Warning: No refresh token received.")
            print("   You may have already authorized this app.")
            print("   Try revoking access and re-authorizing.")
        else:
            print("Access Token (expires in 1 hour):")
            access_token = tokens.get("access_token", "NOT FOUND")
            print(access_token[:50] + "..." if len(access_token) > 50 else access_token)
        
        print()
        print("=" * 60)
        print()
        print("üìã Next steps:")
        print("1. Copy the refresh token above")
        print("2. Add it to your secrets.json file")
        print("3. Re-encrypt the vault")
        print()
        print(f"Example secrets.json:")
        print(json.dumps({
            "gmail": {
                "client_id": client_id,
                "client_secret": client_secret,
                "refresh_token": refresh_token if refresh_token != "NOT FOUND" else "YOUR_REFRESH_TOKEN",
                "user": "your-email@example.com"
            }
        }, indent=2))
        
    except RuntimeError as e:
        print()
        print(f"‚ùå {e}")
        sys.exit(1)
    except Exception as e:
        print()
        print(f"‚ùå Unexpected error: {e}")
        sys.exit(1)


if __name__ == "__main__":
    main()

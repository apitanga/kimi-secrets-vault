#!/bin/bash
#
# kimi-vault Secure Session Launcher
# Decrypts vault, launches AI assistant with credentials available, auto-cleans on exit
#

set -euo pipefail

# Determine script location for sourcing Python module
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

# Add src to Python path for imports
export PYTHONPATH="${PROJECT_DIR}/src:${PYTHONPATH:-}"

# Load config or use defaults
KIMI_VAULT_DIR="${KIMI_VAULT_DIR:-$HOME/.kimi-vault}"
KIMI_VAULT_KEY="${KIMI_VAULT_KEY:-$KIMI_VAULT_DIR/key.txt}"
SECRETS_FILE="${KIMI_VAULT_DIR}/secrets.json.age"
TEMP_SECRETS="/tmp/kimi-vault-secrets-$$.json"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${GREEN}üîê Kimi Secrets Vault - Secure Session${NC}"
echo "========================================"
echo ""

# Check if age is installed
if ! command -v age &> /dev/null; then
    echo -e "${RED}Error: age is not installed${NC}"
    echo "Install from: https://age-encryption.org"
    exit 1
fi

# Check vault exists
if [ ! -f "$SECRETS_FILE" ]; then
    echo -e "${RED}Error: No encrypted secrets found at $SECRETS_FILE${NC}"
    echo ""
    echo "To set up your vault:"
    echo "  1. Copy the template: cp config/secrets.template.json $KIMI_VAULT_DIR/secrets.json"
    echo "  2. Add your credentials"
    echo "  3. Encrypt: age -r \$(cat $KIMI_VAULT_KEY.pub) -o $SECRETS_FILE $KIMI_VAULT_DIR/secrets.json"
    echo "  4. Secure delete: shred -u $KIMI_VAULT_DIR/secrets.json"
    echo ""
    echo "See docs/GMAIL_SETUP.md for detailed instructions."
    exit 1
fi

# Check key exists
if [ ! -f "$KIMI_VAULT_KEY" ]; then
    echo -e "${RED}Error: Age private key not found at $KIMI_VAULT_KEY${NC}"
    echo ""
    echo "To generate a new key pair:"
    echo "  age-keygen -o $KIMI_VAULT_KEY"
    exit 1
fi

# Decrypt
echo -e "${YELLOW}üîì Decrypting vault...${NC}"
if ! age -d -i "$KIMI_VAULT_KEY" "$SECRETS_FILE" > "$TEMP_SECRETS" 2>/dev/null; then
    echo -e "${RED}‚ùå Failed to decrypt vault${NC}"
    echo "Check that your key is correct and the vault file is valid."
    exit 1
fi

# Secure the temp file
chmod 600 "$TEMP_SECRETS"

echo -e "${GREEN}‚úÖ Vault decrypted${NC}"
echo ""
echo -e "${YELLOW}üì¶ Available APIs:${NC}"
echo "  ‚úÖ Gmail (read, compose, send)"
echo ""
echo -e "${BLUE}üí° Quick commands:${NC}"
echo "  python3 -m kimi_vault.cli unread"
echo "  python3 -m kimi_vault.cli search \"from:boss\""
echo ""

# Export variable for client auto-detection
export KIMI_VAULT_SECRETS="$TEMP_SECRETS"
export KIMI_BOT_SECRETS="$TEMP_SECRETS"  # Legacy support

# Cleanup function
cleanup() {
    local exit_code=$?
    echo ""
    echo -e "${YELLOW}üßπ Cleaning up...${NC}"
    
    # Secure delete if shred is available
    if command -v shred &> /dev/null; then
        shred -u "$TEMP_SECRETS" 2>/dev/null || rm -f "$TEMP_SECRETS"
    else
        rm -f "$TEMP_SECRETS"
    fi
    
    echo -e "${GREEN}‚úÖ Secrets shredded${NC}"
    echo -e "${GREEN}üîí Vault closed${NC}"
    exit $exit_code
}
trap cleanup EXIT INT TERM

# Launch AI assistant if available, otherwise just start a shell
if command -v kimi &> /dev/null; then
    echo -e "${GREEN}üöÄ Launching kimi (exit with Ctrl+D or /exit)${NC}"
    echo ""
    
    # Check for agent file
    AGENT_FILE="${HOME}/.config/kimi-vault/agent.yaml"
    if [ -f "$AGENT_FILE" ]; then
        exec kimi --agent-file "$AGENT_FILE"
    else
        exec kimi
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è  kimi not found, starting a secure shell session${NC}"
    echo "Your vault secrets are available via KIMI_VAULT_SECRETS env var."
    echo "Exit this shell to automatically shred the secrets."
    echo ""
    exec "${SHELL:-bash}"
fi
